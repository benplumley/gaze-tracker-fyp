<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">retmat</span> = gaze_calc(<span class="var type1" id="S3T2U6">head_x</span>, <span class="var type1" id="S4T2U7">head_y</span>, <span class="var type1" id="S5T2U8">head_z</span>, <span class="var type1" id="S6T2U9">head_roll</span>, <span class="var type1" id="S7T2U10">head_pitch</span>, <span class="var type1" id="S8T2U11">head_yaw</span>, <span class="var type1" id="S9T2U12">left_eye_x</span>, <span class="var type1" id="S10T2U13">left_eye_y</span>, <span class="var type1" id="S11T2U14">right_eye_x</span>, <span class="var type1" id="S12T2U15">right_eye_y</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="mxinfo " id="T3:U12"><span class="var type1" id="S13T3U18">world</span> = <span class="mxinfo " id="T3:U14">eye(3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="mxinfo " id="T4:U15"><span class="var type1" id="S15T4U24">lefteyep</span> = <span class="mxinfo " id="T4:U17">[<span class="var type1" id="S9T2U27">left_eye_x</span>;<span class="var type1" id="S10T2U29">left_eye_y</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T4:U20"><span class="var type1" id="S16T4U32">righteyep</span> = <span class="mxinfo " id="T4:U22">[<span class="var type1" id="S11T2U35">right_eye_x</span>;<span class="var type1" id="S12T2U37">right_eye_y</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T5:U25"><span class="var type1" id="S17T5U40">face</span> = <span class="mxinfo " id="T5:U27">[ 0 0 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">         1 0 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">         1 1 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">         0 1 0 0 ]'</span></span>; <span class="comment">% a plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%R = RotA( [1;0;0]+face_rotation_rand*randn(3,1), 0.5*pi + face_rotation_rand*pi*rand,1  ); % rotation of face in world</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo " id="T2:U28"><span class="var type1" id="S6T2U65">head_roll</span> = <span class="mxinfo " id="T2:U30">deg2rad(<span class="var type1" id="S6T2U68">head_roll</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T2:U32"><span class="var type1" id="S7T2U71">head_pitch</span> = <span class="mxinfo " id="T2:U34">deg2rad(<span class="var type1" id="S7T2U74">head_pitch</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T2:U36"><span class="var type1" id="S8T2U77">head_yaw</span> = <span class="mxinfo " id="T2:U38">deg2rad(<span class="var type1" id="S8T2U80">head_yaw</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="mxinfo " id="T5:U40"><span class="var type1" id="S19T5U83">R</span> = <span class="mxinfo " id="T5:U42">zeros(<span class="mxinfo " id="T2:U43">4</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="mxinfo " id="T6:U44"><span class="var type1" id="S19T6U89">R</span> = <span class="mxinfo " id="T3:U46"><span class="mxinfo " id="T3:U47"><span class="mxinfo " id="T3:U48"><span class="fcn" id="F36N2:B93">RotX</span>(<span class="var type1" id="S6T2U94">head_roll</span>)</span> * <span class="mxinfo " id="T3:U50"><span class="fcn" id="F37N3:B96">RotY</span>(<span class="var type1" id="S7T2U97">head_pitch</span>)</span></span> * <span class="mxinfo " id="T3:U52"><span class="fcn" id="F60N4:B99">RotZ</span>(<span class="var type1" id="S8T2U100">head_yaw</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T2:U54"><span class="mxinfo " id="T2:U55"><span class="var type1" id="S19T6U104">R</span>(<span class="mxinfo " id="T2:U57">4</span>, <span class="mxinfo " id="T2:U58">4</span>)</span> = <span class="mxinfo " id="T2:U59">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%R = eul2rotm(head_roll, head_pitch, head_yaw); % convert rotation angles to direction cosine matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%T = [1;5;1]+face_translation_rand*randn(3,1); % translation of face in world</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T7:U60"><span class="var type1" id="S24T7U110">T</span> = <span class="mxinfo " id="T7:U62">[<span class="var type1" id="S3T2U113">head_x</span>; <span class="var type1" id="S4T2U115">head_y</span>; <span class="var type1" id="S5T2U117">head_z</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="mxinfo " id="T6:U66"><span class="var type1" id="S25T6U120">M</span> = <span class="var type1" id="S19T6U121">R</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T7:U69"><span class="mxinfo " id="T7:U70"><span class="var type1" id="S25T6U125">M</span>(<span class="mxinfo " id="T8:U72"><span class="mxinfo " id="T2:U73">1</span>:<span class="mxinfo " id="T2:U74">3</span></span>,<span class="mxinfo " id="T2:U75">4</span>)</span> = <span class="var type1" id="S24T7U130">T</span></span>; <span class="comment">% combined rotation and translation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T9:U77"><span class="mxinfo " id="T9:U78"><span class="var type1" id="S17T5U134">face</span>(<span class="mxinfo " id="T10:U80">4</span>,<span class="mxinfo " id="T11:U81">:</span>)</span> = 1</span>; <span class="comment">% need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T12:U82"><span class="var type1" id="S17T12U140">face</span> = <span class="mxinfo " id="T12:U84"><span class="var type1" id="S25T6U142">M</span>*<span class="var type1" id="S17T5U143">face</span></span></span>; <span class="comment">% do the transform</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T13:U87"><span class="var type1" id="S17T13U146">face</span> = <span class="mxinfo " id="T13:U89"><span class="var type1" id="S17T12U148">face</span>(<span class="mxinfo " id="T8:U91"><span class="mxinfo " id="T2:U92">1</span>:<span class="mxinfo " id="T2:U93">3</span></span>,<span class="mxinfo " id="T11:U94">:</span>)</span></span>; <span class="comment">% pick out the new face coordinates</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo " id="T7:U95"><span class="var type1" id="S26T7U155">midface</span> = <span class="mxinfo " id="T7:U97">mean(<span class="var type1" id="S17T13U158">face</span>,2)</span></span>; <span class="comment">% the eye is in the middle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">%x = face - eye; % work out gaze direction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">% calculate normal to the face passing through the eye</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="mxinfo " id="T7:U99"><span class="var type1" id="S28T7U162">a</span> = <span class="mxinfo " id="T7:U101"><span class="mxinfo " id="T7:U102"><span class="var type1" id="S17T13U165">face</span>(<span class="mxinfo " id="T14:U104">:</span>,<span class="mxinfo " id="T10:U105">1</span>)</span> - <span class="var type1" id="S26T7U168">midface</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T7:U107"><span class="var type1" id="S29T7U171">b</span> = <span class="mxinfo " id="T7:U109"><span class="mxinfo " id="T7:U110"><span class="var type1" id="S17T13U174">face</span>(<span class="mxinfo " id="T14:U112">:</span>,<span class="mxinfo " id="T10:U113">2</span>)</span> - <span class="var type1" id="S26T7U177">midface</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="mxinfo " id="T7:U115"><span class="var type1" id="S30T7U180">x</span> = <span class="mxinfo " id="T7:U117">cross(<span class="var type1" id="S28T7U183">a</span>,<span class="var type1" id="S29T7U184">b</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%[U,S,V] = svd(x); % singular value decomposition puts a reference frame onto face</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">%gaze = U(:,3); % gaze is the so-called 'null' vector - out of the plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% for points IN face-space the projection onto the face plane is assumed to</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="comment">% be orthogonal</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">%P = [1 0 0;0 1 0];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">%P = [0 1 0;0 0 1];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%% calculate eye depth based on known coordinates and face plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T7:U120"><span class="var type1" id="S30T7U187">x</span> = <span class="mxinfo " id="T7:U122"><span class="var type1" id="S30T7U189">x</span> ./ <span class="mxinfo " id="T2:U124">norm(<span class="var type1" id="S30T7U192">x</span>)</span></span></span>; <span class="comment">% turn x into a unit vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">%eyep = eyep - (dot(x, (eyep - midface))) * x; % move eyep into the face plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%% screen is treated like the face</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="mxinfo " id="T5:U126"><span class="var type1" id="S33T5U195">screen</span> = <span class="mxinfo " id="T5:U128">[ 0 0 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">           1 0 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">           1 1 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">           0 1 0 0 ]'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="mxinfo " id="T9:U129"><span class="mxinfo " id="T9:U130"><span class="var type1" id="S33T5U221">screen</span>(<span class="mxinfo " id="T10:U132">3</span>,<span class="mxinfo " id="T11:U133">:</span>)</span> = 0</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%R2 = RotA( [1;0;0]+screen_rotation_rand*randn(3,1), 1.5*pi + screen_rotation_rand*pi*rand,1  ); % rotation of face in world</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">%T2 = [1;1;2]+screen_translation_rand*randn(3,1); % translation of face in world</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T3:U134"><span class="var type1" id="S34T3U227">R2</span> = <span class="mxinfo " id="T3:U136">eye(3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T7:U137"><span class="var type1" id="S35T7U233">T2</span> = <span class="mxinfo " id="T7:U139">[0;0;0]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="mxinfo " id="T5:U140"><span class="var type1" id="S36T5U243">M2</span> = <span class="mxinfo " id="T5:U142">zeros(<span class="mxinfo " id="T2:U143">4</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo " id="T6:U144"><span class="var type1" id="S36T6U249">M2</span> = <span class="var type1" id="S34T3U250">R2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T7:U147"><span class="mxinfo " id="T7:U148"><span class="var type1" id="S36T6U254">M2</span>(<span class="mxinfo " id="T8:U150"><span class="mxinfo " id="T2:U151">1</span>:<span class="mxinfo " id="T2:U152">3</span></span>,<span class="mxinfo " id="T2:U153">4</span>)</span> = <span class="var type1" id="S35T7U259">T2</span></span>; <span class="comment">% combined rotation and translation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="mxinfo " id="T9:U155"><span class="mxinfo " id="T9:U156"><span class="var type1" id="S33T5U263">screen</span>(<span class="mxinfo " id="T10:U158">4</span>,<span class="mxinfo " id="T11:U159">:</span>)</span> = 1</span>; <span class="comment">% need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo " id="T12:U160"><span class="var type1" id="S33T12U269">screen</span> = <span class="mxinfo " id="T12:U162"><span class="var type1" id="S36T6U271">M2</span>*<span class="var type1" id="S33T5U272">screen</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T13:U165"><span class="var type1" id="S33T13U275">screen</span> = <span class="mxinfo " id="T13:U167"><span class="var type1" id="S33T12U277">screen</span>(<span class="mxinfo " id="T8:U169"><span class="mxinfo " id="T2:U170">1</span>:<span class="mxinfo " id="T2:U171">3</span></span>,<span class="mxinfo " id="T11:U172">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="mxinfo " id="T7:U173"><span class="var type1" id="S37T7U284">mscr</span> = <span class="mxinfo " id="T7:U175">mean(<span class="var type1" id="S33T13U287">screen</span>,2)</span></span>; <span class="comment">% middle of screen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">%x = screen - mscr; % work our gaze direction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="mxinfo " id="T7:U177"><span class="var type1" id="S28T7U291">a</span> = <span class="mxinfo " id="T7:U179"><span class="mxinfo " id="T7:U180"><span class="var type1" id="S33T13U294">screen</span>(<span class="mxinfo " id="T14:U182">:</span>,<span class="mxinfo " id="T10:U183">1</span>)</span> - <span class="var type1" id="S37T7U297">mscr</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="mxinfo " id="T7:U185"><span class="var type1" id="S29T7U300">b</span> = <span class="mxinfo " id="T7:U187"><span class="mxinfo " id="T7:U188"><span class="var type1" id="S33T13U303">screen</span>(<span class="mxinfo " id="T14:U190">:</span>,<span class="mxinfo " id="T10:U191">2</span>)</span> - <span class="var type1" id="S37T7U306">mscr</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="mxinfo " id="T7:U193"><span class="var type1" id="S38T7U309">x2</span> = <span class="mxinfo " id="T7:U195">cross(<span class="var type1" id="S28T7U312">a</span>,<span class="var type1" id="S29T7U313">b</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%[U2,S2,V2] = svd(x2); % singular value decomposition puts a reference frame onto face</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">%nscr = U2(:,3); %  'null' vector - out of the screen plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%% Map a point in the screen into the face coordinates, via the world</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="mxinfo " id="T2:U198"><span class="var type1" id="S39T2U316">numpoints</span> = <span class="mxinfo " id="T2:U200">4</span></span>; <span class="comment">% number of points to generate the homography from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">%xscr = repmat(mscr, 1, numpoints)+0.3*randn(3,numpoints); % a point on the screen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="mxinfo " id="T13:U201"><span class="var type1" id="S40T13U320">xscr</span> = <span class="mxinfo " id="T13:U203">[ 0 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">           1 0 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">           1 1 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">           0 1 0 ]'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">%xscr = randn(3,numpoints); % a point on the screen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="mxinfo " id="T9:U204"><span class="mxinfo " id="T9:U205"><span class="var type1" id="S40T13U342">xscr</span>(<span class="mxinfo " id="T10:U207">2</span>,<span class="mxinfo " id="T11:U208">:</span>)</span> = 1</span>; <span class="comment">% zero because its in the plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"><span class="comment">%xwrld = (U2*xscr) + repmat(mscr,1,numpoints) % could be a single matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="comment">%xfce = P*U'*(xwrld - repmat(midface,1,numpoints)) % map into face coordinates, could be one matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="comment">%xfce = P*U'*(xwrld - repmat(midface,1,numpoints)) % map into face coordinates, could be one matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%xscr(4,:) = 1 % need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo " id="T5:U209"><span class="var type1" id="S41T5U348">xscr_h</span> = <span class="mxinfo " id="T5:U211">[<span class="var type1" id="S40T13U351">xscr</span>; <span class="mxinfo " id="T9:U213">ones(<span class="mxinfo " id="T2:U214">1</span>, <span class="var type1" id="S39T2U356">numpoints</span>)</span>]</span></span>; <span class="comment">% create homogeneous version</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="mxinfo " id="T15:U216"><span class="var type1" id="S43T15U359">mscr_h</span> = <span class="mxinfo " id="T15:U218">[<span class="var type1" id="S37T7U362">mscr</span>; <span class="mxinfo " id="T2:U220">1</span>]</span></span>; <span class="comment">% create homogeneous version</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="comment">%mscr(4,:) = 1; % need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="comment">%xwrld(4,:) = 1; % need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="comment">%M2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="comment">%xwrld = (M2'*xscr) + repmat(mscr,1,numpoints); % could be a single matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="comment">%xwrld = (M2*xscr)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="mxinfo " id="T12:U221"><span class="var type1" id="S44T12U367">xwrld</span> = <span class="mxinfo " id="T12:U223"><span class="var type1" id="S36T6U369">M2</span>*(<span class="mxinfo " id="T5:U225"><span class="var type1" id="S41T5U372">xscr_h</span> - <span class="mxinfo " id="T5:U227">repmat(<span class="var type1" id="S43T15U375">mscr_h</span>,1,<span class="var type1" id="S39T2U377">numpoints</span>)</span></span>)</span></span>; <span class="comment">% could be a single matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="comment">%midface(4,:) = 1; % need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="mxinfo " id="T15:U230"><span class="var type1" id="S46T15U380">midface_h</span> = <span class="mxinfo " id="T15:U232">[<span class="var type1" id="S26T7U383">midface</span>; <span class="mxinfo " id="T2:U234">1</span>]</span></span>; <span class="comment">% create homogeneous version</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="mxinfo " id="T9:U235"><span class="mxinfo " id="T9:U236"><span class="var type1" id="S44T12U389">xwrld</span>(<span class="mxinfo " id="T2:U238">4</span>,<span class="mxinfo " id="T11:U239">:</span>)</span> = 1</span>; <span class="comment">% need homogeneous coordinates for it to work !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">%xfce = P*U'*(xwrld - repmat(midface,1,numpoints)) % map into face coordinates, could be one matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%xfce = M*(xwrld - repmat(midface,1,numpoints)); % map into face coordinates, could be one matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%xfce = (M*xwrld) - repmat(midface,1,numpoints); % map into face coordinates, could be one matrix !</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="mxinfo " id="T5:U240"><span class="var type1" id="S47T5U395">xfce</span> = <span class="mxinfo " id="T5:U242">(<span class="mxinfo " id="T12:U243"><span class="var type1" id="S25T6U399">M</span>*<span class="var type1" id="S44T12U400">xwrld</span></span>) + <span class="mxinfo " id="T5:U246">repmat(<span class="var type1" id="S46T15U403">midface_h</span>,1,<span class="var type1" id="S39T2U405">numpoints</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">%xfce = M*(xwrld + repmat(midface,1,numpoints));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="comment">%xwrld(1:2,:)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">%xwrld(3,:)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="mxinfo " id="T13:U249"><span class="var type1" id="S47T13U408">xfce</span> = <span class="mxinfo " id="T13:U251">bsxfun(@rdivide, <span class="mxinfo " id="T13:U252"><span class="var type1" id="S47T5U414">xfce</span>(<span class="mxinfo " id="T14:U254">1:3</span>,<span class="mxinfo " id="T11:U255">:</span>)</span>, <span class="mxinfo " id="T9:U256"><span class="var type1" id="S47T5U420">xfce</span>(<span class="mxinfo " id="T10:U258">4</span>,<span class="mxinfo " id="T11:U259">:</span>)</span>)</span></span>; <span class="comment">% make face coords nonhomogeneous again</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="comment">%xscr = bsxfun(@rdivide, xscr(1:3,:), xscr(4,:)); % make face coords nonhomogeneous again</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="mxinfo " id="T7:U260"><span class="var type1" id="S26T7U425">midface</span> = <span class="mxinfo " id="T7:U262"><span class="var type1" id="S26T7U427">midface</span>(<span class="mxinfo " id="T8:U264"><span class="mxinfo " id="T2:U265">1</span>:<span class="mxinfo " id="T2:U266">3</span></span>,<span class="mxinfo " id="T10:U267">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"><span class="comment">%mscr = mscr(1:3,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S50T2U434">i</span> = <span class="mxinfo " id="T2:U269">1</span>:<span class="var type1" id="S39T2U437">numpoints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="mxinfo " id="T7:U271"><span class="mxinfo " id="T7:U272"><span class="var type1" id="S47T13U441">xfce</span>(<span class="mxinfo " id="T14:U274">:</span>,<span class="var type1" id="S50T2U443">i</span>)</span> = <span class="mxinfo " id="T7:U276"><span class="mxinfo " id="T7:U277"><span class="var type1" id="S47T13U446">xfce</span>(<span class="mxinfo " id="T14:U279">:</span>,<span class="var type1" id="S50T2U448">i</span>)</span> - <span class="mxinfo " id="T7:U281">(<span class="mxinfo " id="T2:U282">dot(<span class="var type1" id="S30T7U453">x</span>, (<span class="mxinfo " id="T7:U284"><span class="mxinfo " id="T7:U285"><span class="var type1" id="S47T13U457">xfce</span>(<span class="mxinfo " id="T14:U287">:</span>,<span class="var type1" id="S50T2U459">i</span>)</span> - <span class="var type1" id="S26T7U460">midface</span></span>))</span>) * <span class="var type1" id="S30T7U461">x</span></span></span></span>; <span class="comment">% move them into the face plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    <span class="mxinfo " id="T7:U291"><span class="mxinfo " id="T7:U292"><span class="var type1" id="S40T13U465">xscr</span>(<span class="mxinfo " id="T14:U294">:</span>,<span class="var type1" id="S50T2U467">i</span>)</span> = <span class="mxinfo " id="T7:U296"><span class="mxinfo " id="T7:U297"><span class="var type1" id="S40T13U470">xscr</span>(<span class="mxinfo " id="T14:U299">:</span>,<span class="var type1" id="S50T2U472">i</span>)</span> - <span class="mxinfo " id="T7:U301">(<span class="mxinfo " id="T2:U302">dot(<span class="var type1" id="S38T7U477">x2</span>, (<span class="mxinfo " id="T7:U304"><span class="mxinfo " id="T7:U305"><span class="var type1" id="S40T13U481">xscr</span>(<span class="mxinfo " id="T14:U307">:</span>,<span class="var type1" id="S50T2U483">i</span>)</span> - <span class="var type1" id="S37T7U484">mscr</span></span>))</span>) * <span class="var type1" id="S38T7U485">x2</span></span></span></span>; <span class="comment">% move them into the screen plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="comment">%xfce = xfce - (dot(x, (xfce - repmat(midface,1,numpoints)))) * x; % move them into the face plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="comment">%xscr = xscr - (dot(x2, (xscr - repmat(mscr,1,numpoints)))) * x2; % move them into the screen plane</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="comment">%% the points xfce and xscr must be related by a homography because the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"><span class="comment">% mapping is from one plane to another. Here is a sanity check</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"><span class="comment">%xscr(3,:) = 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"><span class="comment">%xfce(3,:) = 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"><span class="comment">%H = homography_est( xscr, xfce )</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"><span class="comment">%xfce = xfce([1,3],:)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="comment">%xscr = xscr([1,3],:)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"><span class="mxinfo " id="T3:U311"><span class="var type1" id="S52T3U488">H</span> = <span class="mxinfo " id="T3:U313"><span class="fcn" id="F439N7:B490">homography_solve</span>( <span class="mxinfo " id="T16:U314"><span class="var type1" id="S47T13U492">xfce</span>(<span class="mxinfo " id="T17:U316">[1,3]</span>,<span class="mxinfo " id="T11:U317">:</span>)</span>, <span class="mxinfo " id="T16:U318"><span class="var type1" id="S40T13U499">xscr</span>(<span class="mxinfo " id="T17:U320">[1,3]</span>,<span class="mxinfo " id="T11:U321">:</span>)</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line"><span class="comment">% z = H*xscr;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line"><span class="comment">% z_nh = bsxfun(@rdivide, z(1:2,:), z(3,:));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"><span class="comment">% d = z_nh - xfce(1:2,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"><span class="comment">% max(abs(d(:)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line"><span class="mxinfo " id="T7:U322"><span class="var type1" id="S54T7U507">lefteyep_h</span> = <span class="mxinfo " id="T7:U324">[<span class="var type1" id="S15T4U510">lefteyep</span>; <span class="mxinfo " id="T2:U326">1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="mxinfo " id="T7:U327"><span class="var type1" id="S55T7U515">righteyep_h</span> = <span class="mxinfo " id="T7:U329">[<span class="var type1" id="S16T4U518">righteyep</span>; <span class="mxinfo " id="T2:U331">1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="mxinfo " id="T7:U332"><span class="var type1" id="S56T7U523">leftscreenp</span> = <span class="mxinfo " id="T7:U334"><span class="var type1" id="S52T3U525">H</span>*<span class="var type1" id="S54T7U526">lefteyep_h</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="mxinfo " id="T7:U337"><span class="var type1" id="S57T7U529">rightscreenp</span> = <span class="mxinfo " id="T7:U339"><span class="var type1" id="S52T3U531">H</span>*<span class="var type1" id="S55T7U532">righteyep_h</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="comment">%lefteyep = lefteyep(1:2,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line"><span class="comment">%righteyep = righteyep(1:2,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line"><span class="comment">%x2 = x2 ./ norm(x2); % turn x into a unit vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line"><span class="mxinfo " id="T4:U342"><span class="var type1" id="S56T4U535">leftscreenp</span> = <span class="mxinfo " id="T4:U344">bsxfun(@rdivide, <span class="mxinfo " id="T4:U345"><span class="var type1" id="S56T7U541">leftscreenp</span>(<span class="mxinfo " id="T17:U347">1:2</span>,<span class="mxinfo " id="T10:U348">:</span>)</span>, <span class="mxinfo " id="T2:U349"><span class="var type1" id="S56T7U547">leftscreenp</span>(<span class="mxinfo " id="T10:U351">3</span>,<span class="mxinfo " id="T10:U352">:</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line"><span class="mxinfo " id="T4:U353"><span class="var type1" id="S57T4U552">rightscreenp</span> = <span class="mxinfo " id="T4:U355">bsxfun(@rdivide, <span class="mxinfo " id="T4:U356"><span class="var type1" id="S57T7U558">rightscreenp</span>(<span class="mxinfo " id="T17:U358">1:2</span>,<span class="mxinfo " id="T10:U359">:</span>)</span>, <span class="mxinfo " id="T2:U360"><span class="var type1" id="S57T7U564">rightscreenp</span>(<span class="mxinfo " id="T10:U362">3</span>,<span class="mxinfo " id="T10:U363">:</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line"><span class="mxinfo " id="T1:U364"><span class="var type1" id="S2T1U569">retmat</span> = <span class="mxinfo " id="T1:U366">[<span class="mxinfo " id="T18:U367"><span class="var type1" id="S56T4U573">leftscreenp</span>'</span>; <span class="mxinfo " id="T18:U369"><span class="var type1" id="S57T4U576">rightscreenp</span>'</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line"><span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"></span></span>
</pre>
